import{r as p,j as c}from"./index-BeR20TLD.js";import{a as F,l as k}from"./axios-BITR5ggg.js";function g(e){return new Promise(t=>setTimeout(t,e))}function S(e){return e.donation.name?w(e.donation.name,e.page.blacklisted_words,"*****"):"Аноним"}function x(e){if(!e.donation.message)return{text:"",voice:""};let t=w(e.donation.message,e.page.blacklisted_words,"*****"),a=w(e.donation.message,e.page.blacklisted_words);return e.page.remove_links&&(t=_(t,"[ссылка удалена]"),a=_(a)),{text:t,voice:$(a)}}function w(e,t,a){let d=e;for(const l of t.filter(s=>s.trim()!=="")){const s=new RegExp(l,"gi");d=d.replace(s,a||"")}return d}function _(e,t){const a=/http[s]?:\/\/(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+/g;return e.replace(a,t||"")}function $(e){const t=/([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF\uDC00-\uDFFF]|\u24C2|[\u25A0-\u25FF]|\u2600-\u26FF|\u2B50|[\u2300-\u23FF]|\u3297|\u3299|[\u2049\u203C]|[\u2000-\u200F]|[\u2028-\u202F]|[\u205F-\u2060]|[\u2190-\u21FF])/g;return e.replace(t,"")}function j({event:e,onEnd:t,token:a,voices:d}){const[l,s]=p.useState(""),r=p.useRef(null);p.useEffect(()=>{const n=async i=>{i&&i!==0&&await g(i),i!==0&&(s("fade-out"),await g(1e3)),t()},h=()=>{const i=()=>{if(e.donation.audio){const o=new Audio(e.donation.audio);o.volume=e.page.voice_volume_percent/100,r.current=o,o.play().catch(u=>{console.error(u),n(1500)}),o.onended=()=>{n(1500)}}else if(x(e).voice.trim()!==""&&e.page.voice_enabled&&e.donation.amount>=e.page.voice_min_amount)if(e.page.voice_type==="maxim")try{const o=new Audio(`https://api.tipmeadollar.com/tts?text=${encodeURIComponent(x(e).voice.trim())}&speed=${e.page.voice_speed}`);o.volume=e.page.voice_volume_percent/100,r.current=o,o.play().catch(u=>{console.error(u),n(1500)}),o.onended=()=>{n(1500)}}catch(o){console.error(o),n(1500)}else{const o=new SpeechSynthesisUtterance(x(e).voice.trim());o.lang="ru-RU";const u=d.find(m=>m.name.startsWith("Google")&&m.lang==="ru-RU");u&&(o.voice=u),o.volume=e.page.voice_volume_percent/100,o.rate=e.page.voice_speed,o.onend=()=>{n(1500)},speechSynthesis.speak(o)}else n(e.widget.duration*1e3)};if(e.widget.sound){r.current&&(r.current.pause(),r.current.currentTime=0);try{const o=new Audio(e.widget.sound);o.volume=e.widget.sound_volume/100,r.current=o,o.play().catch(u=>{console.error(u),i()}),o.onended=()=>{i()}}catch{i()}}else i()};return(async()=>(s(""),h(),e.socket.on("donations:skip",()=>{n(0)})))(),(async()=>{try{await F.post("https://api.tipmeadollar.com/internal/socket/read",{id:e.donation.id,token:a})}catch{}})(),()=>{r.current&&(r.current.pause(),r.current.currentTime=0,r.current=null),speechSynthesis.cancel(),e.socket.off("donations:skip")}},[e]);const f=n=>({fontSize:n.size,color:n.color,fontWeight:n.bold?"bold":"normal",fontStyle:n.italic?"italic":"normal",fontDecoration:n.underline?"underline":"none",textTransform:n.transform,textShadow:`0px 0px ${n.shadow_size}px ${n.shadow_color}, 0px 0px ${n.shadow_size+1}px ${n.shadow_color}, 0px 0px ${n.shadow_size+2}px ${n.shadow_color}, 0px 0px ${n.shadow_size+3}px ${n.shadow_color}, 0px 0px ${n.shadow_size+4}px ${n.shadow_color}`});return c.jsxs("div",{id:"donation",className:`donation ${l}`,children:[c.jsx("div",{className:"donation-container-item",children:c.jsx("div",{className:"donation-image",id:"donation-image",style:{backgroundImage:e.widget.image?`url(${e.widget.image})`:""}})}),c.jsx("div",{className:"donation-container-item",children:c.jsxs("h1",{id:"donation-title",className:"donation-title",style:f(e.widget.title_settings),children:[S(e)," – ",e.donation.amount/100," ",e.donation.currency,"!"]})}),c.jsx("div",{className:"donation-container-item",children:c.jsx("p",{id:"donation-message",className:"donation-message",style:f(e.widget.message_settings),children:x(e).text})})]})}function N(){const t=new URLSearchParams(window.location.search).get("key"),[a,d]=p.useState(null),l=p.useRef([]),s=p.useRef(!1),[r,f]=p.useState(window.speechSynthesis.getVoices());p.useEffect(()=>{const o=k("https://socket.tipmeadollar.com",{reconnection:!0,reconnectionDelayMax:5e3,reconnectionDelay:1e3});return o.on("connect",()=>{console.log("Connected to Socket.IO server"),o.emit("authenticate",JSON.stringify({token:t}))}),o.on("donations:new",u=>{const m=JSON.parse(u);console.log("New donation received",m),l.current.find(y=>y.donation.id===m.donation.id)||n({...m,socket:o})}),window.speechSynthesis.onvoiceschanged=function(){f(window.speechSynthesis.getVoices())},()=>{o.disconnect()}},[]);const n=o=>{l.current.push(o),s.current||h()},h=()=>{if(l.current.length>0){const o=l.current.shift();d(o),s.current=!0}else d(null),s.current=!1},i=()=>{s.current=!1,h()};return c.jsx(c.Fragment,{children:a?c.jsx(j,{event:a,onEnd:i,token:t||"",voices:r}):c.jsx(c.Fragment,{})})}export{N as default};
