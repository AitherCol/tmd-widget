import{r as c,j as a}from"./index-DkIiY9Ul.js";import{a as S,l as _}from"./axios-BITR5ggg.js";import{g as y,f as k,a as g,s as w}from"./utils-Dua54zap.js";function j({event:e,onEnd:l,token:u,voices:m}){const[d,r]=c.useState(""),s=c.useRef(null);return c.useEffect(()=>{const i=async t=>{t&&t!==0&&await w(t),t!==0&&(r("fade-out"),await w(1e3)),l()},f=()=>{const t=()=>{if(e.donation.audio){const o=new Audio(e.donation.audio);o.volume=e.page.voice_volume_percent/100,s.current=o,o.play().catch(n=>{console.error(n),i(1500)}),o.onended=()=>{i(1500)}}else if(g(e).voice.trim()!==""&&e.page.voice_enabled&&e.donation.amount>=e.page.voice_min_amount)if(e.page.voice_type!=="svetlana")try{const o=new Audio(`https://api.tipmeadollar.com/tts?text=${encodeURIComponent(g(e).voice.trim())}&speed=${e.page.voice_speed}&voice=${e.page.voice_type}`);o.volume=e.page.voice_volume_percent/100,s.current=o,o.play().catch(n=>{console.error(n),i(1500)}),o.onended=()=>{i(1500)}}catch(o){console.error(o),i(1500)}else{const o=new SpeechSynthesisUtterance(g(e).voice.trim());o.lang="ru-RU";const n=m.find(p=>p.name.startsWith("Google")&&p.lang==="ru-RU");n&&(o.voice=n),o.volume=e.page.voice_volume_percent/100,o.rate=e.page.voice_speed,o.onend=()=>{i(1500)},speechSynthesis.speak(o)}else i(e.widget.duration*1e3)};if(e.widget.sound){s.current&&(s.current.pause(),s.current.currentTime=0);try{const o=new Audio(e.widget.sound);o.volume=e.widget.sound_volume/100,s.current=o,o.play().catch(n=>{console.error(n),t()}),o.onended=()=>{t()}}catch{t()}}else t()};return(async()=>(r(""),f(),e.socket.on("donations:skip",()=>{i(0)})))(),(async()=>{try{await S.post("https://api.tipmeadollar.com/public/donations/read",{id:e.donation.id,token:u})}catch{}})(),()=>{s.current&&(s.current.pause(),s.current.currentTime=0,s.current=null),speechSynthesis.cancel(),e.socket.off("donations:skip")}},[e]),a.jsxs("div",{id:"donation",className:`donation ${d}`,children:[a.jsx("div",{className:"donation-container-item",children:a.jsx("div",{className:"donation-image",id:"donation-image",style:{backgroundImage:e.widget.image?`url(${e.widget.image})`:""}})}),a.jsx("div",{className:"donation-container-item",children:a.jsxs("h1",{id:"donation-title",className:"donation-title",style:y(e.widget.title_settings),children:[k(e)," â€“ ",e.donation.amount/100," ",e.donation.currency,"!"]})}),a.jsx("div",{className:"donation-container-item",children:a.jsx("p",{id:"donation-message",className:"donation-message",style:y(e.widget.message_settings),children:g(e).text})})]})}function E(){const l=new URLSearchParams(window.location.search).get("key"),[u,m]=c.useState(null),d=c.useRef([]),r=c.useRef(!1),[s,i]=c.useState(window.speechSynthesis.getVoices());c.useEffect(()=>{const n=_("https://socket.tipmeadollar.com",{reconnection:!0,reconnectionDelayMax:5e3,reconnectionDelay:1e3});return n.on("connect",()=>{console.log("Connected to Socket.IO server"),n.emit("authenticate",JSON.stringify({token:l}))}),n.on("donations:new",p=>{const h=JSON.parse(p);console.log("New donation received",h),d.current.find(x=>x.donation.id===h.donation.id)||f({...h,socket:n})}),window.speechSynthesis.onvoiceschanged=function(){i(window.speechSynthesis.getVoices())},()=>{n.disconnect()}},[]);const f=n=>{d.current.push(n),r.current||t()},t=()=>{if(d.current.length>0){const n=d.current.shift();m(n),r.current=!0}else m(null),r.current=!1},o=()=>{r.current=!1,t()};return a.jsx(a.Fragment,{children:u?a.jsx(j,{event:u,onEnd:o,token:l||"",voices:s}):a.jsx(a.Fragment,{})})}export{E as default};
